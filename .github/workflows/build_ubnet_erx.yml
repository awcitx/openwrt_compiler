name: Build OpenWrt erx

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'Enable SSH connection to Actions'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-22.04  # 用 22.04 避免 ubuntu-latest 的 Python 3.12 问题（可选，但更稳）

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11  # 关键：强制用 3.11 解决 node configure distutils 错误
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python3-setuptools python3-pyelftools rsync subversion swig time unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 flex bison g++ g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler ccache ecj fastjar mkisofs xsltproc wget vim-common bash patch libelf-dev

    - name: Clone Lede source
      run: |
        git clone https://github.com/coolsnowwolf/lede.git openwrt
        cd openwrt
        git checkout master  # 或指定 tag 如 v23.05，如果需要稳定版

    - name: Update and install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom config for ER-X
      run: |
        cd openwrt
        # 复制你的 .config_mt7621 到 .config（仓库根目录的 config 文件）
        cp ../.config_mt7621 .config
        # 或者如果你想在 workflow 里强制启用某些包，这里可以 sed 修改 .config
        # 示例：强制启用 ssr-plus
        sed -i 's/# CONFIG_PACKAGE_luci-app-ssr-plus is not set/CONFIG_PACKAGE_luci-app-ssr-plus=y/g' .config
        make defconfig

    - name: Download dl files (cache)
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/include/**') }}-${{ hashFiles('openwrt/package/**') }}

    - name: Build OpenWrt
      run: |
        cd openwrt
        # -j$(nproc) 加速，但第一次慢；出错时可改 -j1 V=s 看详细日志
        make -j$(nproc) V=s || make -j1 V=s

    - name: Prepare Artifacts
      run: |
        cd openwrt/bin/targets/ramips/mt7621/
        mkdir -p artifacts
        cp *factory* *initramfs* *sysupgrade* artifacts/ 2>/dev/null || true
        ls -l artifacts/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-erx-firmware
        path: openwrt/bin/targets/ramips/mt7621/artifacts/*
        retention-days: 7

    - name: SSH connection to Actions (optional debug)
      if: github.event.inputs.ssh == 'true'
      uses: lhotari/action-upterm@v1
